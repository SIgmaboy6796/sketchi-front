var Ye=Object.defineProperty;var He=(d,o,i)=>o in d?Ye(d,o,{enumerable:!0,configurable:!0,writable:!0,value:i}):d[o]=i;var h=(d,o,i)=>(He(d,typeof o!="symbol"?o+"":o,i),i);import{r as C,c as Ke}from"./zustand-ebf5350a.js";import{r as Ue}from"./react-0138d7aa.js";import{E as Xe,V as T,M as q,T as G,Q as we,S as xe,a as A,b as Ze,c as H,d as K,C as Ee,B as Ve,P as Be,D as $e,e as Z,R as Qe,f as Je,g as et,W as tt,A as ot,h as nt,i as st,j as it,k as at}from"./three-ea9f4bfc.js";import{l as rt,c as ee,g as ct}from"./h3-js-16254e39.js";(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))e(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function i(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(n){if(n.ep)return;n.ep=!0;const s=i(n);fetch(n.href,s)}})();var Te={exports:{}},V={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var lt=C,ht=Symbol.for("react.element"),dt=Symbol.for("react.fragment"),ut=Object.prototype.hasOwnProperty,mt=lt.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,pt={key:!0,ref:!0,__self:!0,__source:!0};function ve(d,o,i){var e,n={},s=null,a=null;i!==void 0&&(s=""+i),o.key!==void 0&&(s=""+o.key),o.ref!==void 0&&(a=o.ref);for(e in o)ut.call(o,e)&&!pt.hasOwnProperty(e)&&(n[e]=o[e]);if(d&&d.defaultProps)for(e in o=d.defaultProps,o)n[e]===void 0&&(n[e]=o[e]);return{$$typeof:ht,type:d,key:s,ref:a,props:n,_owner:mt.current}}V.Fragment=dt;V.jsx=ve;V.jsxs=ve;Te.exports=V;var b=Te.exports,oe={},Me=Ue;oe.createRoot=Me.createRoot,oe.hydrateRoot=Me.hydrateRoot;const Pe={type:"change"},te={type:"start"},Se={type:"end"};class ft extends Xe{constructor(o,i){super(),this.object=o,this.domElement=i,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new T,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:q.ROTATE,MIDDLE:q.DOLLY,RIGHT:q.PAN},this.touches={ONE:G.ROTATE,TWO:G.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return c.phi},this.getAzimuthalAngle=function(){return c.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(t){t.addEventListener("keydown",Q),this._domElementKeyEvents=t},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",Q),this._domElementKeyEvents=null},this.saveState=function(){e.target0.copy(e.target),e.position0.copy(e.object.position),e.zoom0=e.object.zoom},this.reset=function(){e.target.copy(e.target0),e.object.position.copy(e.position0),e.object.zoom=e.zoom0,e.object.updateProjectionMatrix(),e.dispatchEvent(Pe),e.update(),s=n.NONE},this.update=function(){const t=new T,r=new we().setFromUnitVectors(o.up,new T(0,1,0)),E=r.clone().invert(),P=new T,I=new we,X=new T,_=2*Math.PI;return function(){const ye=e.object.position;t.copy(ye).sub(e.target),t.applyQuaternion(r),c.setFromVector3(t),e.autoRotate&&s===n.NONE&&z(O()),e.enableDamping?(c.theta+=p.theta*e.dampingFactor,c.phi+=p.phi*e.dampingFactor):(c.theta+=p.theta,c.phi+=p.phi);let j=e.minAzimuthAngle,k=e.maxAzimuthAngle;return isFinite(j)&&isFinite(k)&&(j<-Math.PI?j+=_:j>Math.PI&&(j-=_),k<-Math.PI?k+=_:k>Math.PI&&(k-=_),j<=k?c.theta=Math.max(j,Math.min(k,c.theta)):c.theta=c.theta>(j+k)/2?Math.max(j,c.theta):Math.min(k,c.theta)),c.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,c.phi)),c.makeSafe(),c.radius*=f,c.radius=Math.max(e.minDistance,Math.min(e.maxDistance,c.radius)),e.enableDamping===!0?e.target.addScaledVector(m,e.dampingFactor):e.target.add(m),t.setFromSpherical(c),t.applyQuaternion(E),ye.copy(e.target).add(t),e.object.lookAt(e.target),e.enableDamping===!0?(p.theta*=1-e.dampingFactor,p.phi*=1-e.dampingFactor,m.multiplyScalar(1-e.dampingFactor)):(p.set(0,0,0),m.set(0,0,0)),f=1,M||P.distanceToSquared(e.object.position)>a||8*(1-I.dot(e.object.quaternion))>a||X.distanceToSquared(e.target)>0?(e.dispatchEvent(Pe),P.copy(e.object.position),I.copy(e.object.quaternion),X.copy(e.target),M=!1,!0):!1}}(),this.dispose=function(){e.domElement.removeEventListener("contextmenu",ge),e.domElement.removeEventListener("pointerdown",pe),e.domElement.removeEventListener("pointercancel",Y),e.domElement.removeEventListener("wheel",fe),e.domElement.removeEventListener("pointermove",$),e.domElement.removeEventListener("pointerup",Y),e._domElementKeyEvents!==null&&(e._domElementKeyEvents.removeEventListener("keydown",Q),e._domElementKeyEvents=null)};const e=this,n={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let s=n.NONE;const a=1e-6,c=new xe,p=new xe;let f=1;const m=new T;let M=!1;const w=new A,S=new A,v=new A,L=new A,x=new A,R=new A,l=new A,g=new A,y=new A,u=[],N={};function O(){return 2*Math.PI/60/60*e.autoRotateSpeed}function D(){return Math.pow(.95,e.zoomSpeed)}function z(t){p.theta-=t}function W(t){p.phi-=t}const ne=function(){const t=new T;return function(E,P){t.setFromMatrixColumn(P,0),t.multiplyScalar(-E),m.add(t)}}(),se=function(){const t=new T;return function(E,P){e.screenSpacePanning===!0?t.setFromMatrixColumn(P,1):(t.setFromMatrixColumn(P,0),t.crossVectors(e.object.up,t)),t.multiplyScalar(E),m.add(t)}}(),F=function(){const t=new T;return function(E,P){const I=e.domElement;if(e.object.isPerspectiveCamera){const X=e.object.position;t.copy(X).sub(e.target);let _=t.length();_*=Math.tan(e.object.fov/2*Math.PI/180),ne(2*E*_/I.clientHeight,e.object.matrix),se(2*P*_/I.clientHeight,e.object.matrix)}else e.object.isOrthographicCamera?(ne(E*(e.object.right-e.object.left)/e.object.zoom/I.clientWidth,e.object.matrix),se(P*(e.object.top-e.object.bottom)/e.object.zoom/I.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),e.enablePan=!1)}}();function B(t){e.object.isPerspectiveCamera?f/=t:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom*t)),e.object.updateProjectionMatrix(),M=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function ie(t){e.object.isPerspectiveCamera?f*=t:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/t)),e.object.updateProjectionMatrix(),M=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function ae(t){w.set(t.clientX,t.clientY)}function Oe(t){l.set(t.clientX,t.clientY)}function re(t){L.set(t.clientX,t.clientY)}function Le(t){S.set(t.clientX,t.clientY),v.subVectors(S,w).multiplyScalar(e.rotateSpeed);const r=e.domElement;z(2*Math.PI*v.x/r.clientHeight),W(2*Math.PI*v.y/r.clientHeight),w.copy(S),e.update()}function Ie(t){g.set(t.clientX,t.clientY),y.subVectors(g,l),y.y>0?B(D()):y.y<0&&ie(D()),l.copy(g),e.update()}function Ae(t){x.set(t.clientX,t.clientY),R.subVectors(x,L).multiplyScalar(e.panSpeed),F(R.x,R.y),L.copy(x),e.update()}function Re(t){t.deltaY<0?ie(D()):t.deltaY>0&&B(D()),e.update()}function je(t){let r=!1;switch(t.code){case e.keys.UP:t.ctrlKey||t.metaKey||t.shiftKey?W(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):F(0,e.keyPanSpeed),r=!0;break;case e.keys.BOTTOM:t.ctrlKey||t.metaKey||t.shiftKey?W(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):F(0,-e.keyPanSpeed),r=!0;break;case e.keys.LEFT:t.ctrlKey||t.metaKey||t.shiftKey?z(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):F(e.keyPanSpeed,0),r=!0;break;case e.keys.RIGHT:t.ctrlKey||t.metaKey||t.shiftKey?z(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):F(-e.keyPanSpeed,0),r=!0;break}r&&(t.preventDefault(),e.update())}function ce(){if(u.length===1)w.set(u[0].pageX,u[0].pageY);else{const t=.5*(u[0].pageX+u[1].pageX),r=.5*(u[0].pageY+u[1].pageY);w.set(t,r)}}function le(){if(u.length===1)L.set(u[0].pageX,u[0].pageY);else{const t=.5*(u[0].pageX+u[1].pageX),r=.5*(u[0].pageY+u[1].pageY);L.set(t,r)}}function he(){const t=u[0].pageX-u[1].pageX,r=u[0].pageY-u[1].pageY,E=Math.sqrt(t*t+r*r);l.set(0,E)}function ke(){e.enableZoom&&he(),e.enablePan&&le()}function Ce(){e.enableZoom&&he(),e.enableRotate&&ce()}function de(t){if(u.length==1)S.set(t.pageX,t.pageY);else{const E=J(t),P=.5*(t.pageX+E.x),I=.5*(t.pageY+E.y);S.set(P,I)}v.subVectors(S,w).multiplyScalar(e.rotateSpeed);const r=e.domElement;z(2*Math.PI*v.x/r.clientHeight),W(2*Math.PI*v.y/r.clientHeight),w.copy(S)}function ue(t){if(u.length===1)x.set(t.pageX,t.pageY);else{const r=J(t),E=.5*(t.pageX+r.x),P=.5*(t.pageY+r.y);x.set(E,P)}R.subVectors(x,L).multiplyScalar(e.panSpeed),F(R.x,R.y),L.copy(x)}function me(t){const r=J(t),E=t.pageX-r.x,P=t.pageY-r.y,I=Math.sqrt(E*E+P*P);g.set(0,I),y.set(0,Math.pow(g.y/l.y,e.zoomSpeed)),B(y.y),l.copy(g)}function Ne(t){e.enableZoom&&me(t),e.enablePan&&ue(t)}function De(t){e.enableZoom&&me(t),e.enableRotate&&de(t)}function pe(t){e.enabled!==!1&&(u.length===0&&(e.domElement.setPointerCapture(t.pointerId),e.domElement.addEventListener("pointermove",$),e.domElement.addEventListener("pointerup",Y)),Ge(t),t.pointerType==="touch"?Fe(t):_e(t))}function $(t){e.enabled!==!1&&(t.pointerType==="touch"?qe(t):ze(t))}function Y(t){We(t),u.length===0&&(e.domElement.releasePointerCapture(t.pointerId),e.domElement.removeEventListener("pointermove",$),e.domElement.removeEventListener("pointerup",Y)),e.dispatchEvent(Se),s=n.NONE}function _e(t){let r;switch(t.button){case 0:r=e.mouseButtons.LEFT;break;case 1:r=e.mouseButtons.MIDDLE;break;case 2:r=e.mouseButtons.RIGHT;break;default:r=-1}switch(r){case q.DOLLY:if(e.enableZoom===!1)return;Oe(t),s=n.DOLLY;break;case q.ROTATE:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enablePan===!1)return;re(t),s=n.PAN}else{if(e.enableRotate===!1)return;ae(t),s=n.ROTATE}break;case q.PAN:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enableRotate===!1)return;ae(t),s=n.ROTATE}else{if(e.enablePan===!1)return;re(t),s=n.PAN}break;default:s=n.NONE}s!==n.NONE&&e.dispatchEvent(te)}function ze(t){switch(s){case n.ROTATE:if(e.enableRotate===!1)return;Le(t);break;case n.DOLLY:if(e.enableZoom===!1)return;Ie(t);break;case n.PAN:if(e.enablePan===!1)return;Ae(t);break}}function fe(t){e.enabled===!1||e.enableZoom===!1||s!==n.NONE||(t.preventDefault(),e.dispatchEvent(te),Re(t),e.dispatchEvent(Se))}function Q(t){e.enabled===!1||e.enablePan===!1||je(t)}function Fe(t){switch(be(t),u.length){case 1:switch(e.touches.ONE){case G.ROTATE:if(e.enableRotate===!1)return;ce(),s=n.TOUCH_ROTATE;break;case G.PAN:if(e.enablePan===!1)return;le(),s=n.TOUCH_PAN;break;default:s=n.NONE}break;case 2:switch(e.touches.TWO){case G.DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;ke(),s=n.TOUCH_DOLLY_PAN;break;case G.DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;Ce(),s=n.TOUCH_DOLLY_ROTATE;break;default:s=n.NONE}break;default:s=n.NONE}s!==n.NONE&&e.dispatchEvent(te)}function qe(t){switch(be(t),s){case n.TOUCH_ROTATE:if(e.enableRotate===!1)return;de(t),e.update();break;case n.TOUCH_PAN:if(e.enablePan===!1)return;ue(t),e.update();break;case n.TOUCH_DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;Ne(t),e.update();break;case n.TOUCH_DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;De(t),e.update();break;default:s=n.NONE}}function ge(t){e.enabled!==!1&&t.preventDefault()}function Ge(t){u.push(t)}function We(t){delete N[t.pointerId];for(let r=0;r<u.length;r++)if(u[r].pointerId==t.pointerId){u.splice(r,1);return}}function be(t){let r=N[t.pointerId];r===void 0&&(r=new A,N[t.pointerId]=r),r.set(t.pageX,t.pageY)}function J(t){const r=t.pointerId===u[0].pointerId?u[1]:u[0];return N[r.pointerId]}e.domElement.addEventListener("contextmenu",ge),e.domElement.addEventListener("pointerdown",pe),e.domElement.addEventListener("pointercancel",Y),e.domElement.addEventListener("wheel",fe,{passive:!1}),this.update()}}class gt{constructor(o){h(this,"scene");h(this,"cities");h(this,"units");h(this,"projectiles");h(this,"globe",null);h(this,"globeRadius",210);h(this,"territorySize",0);h(this,"centers",[]);h(this,"centerNeighbors",[]);h(this,"centerWater",[]);h(this,"centerOwned",[]);h(this,"centerLat",[]);h(this,"centerLng",[]);h(this,"hexagons",[]);h(this,"biomes",[]);h(this,"elevations",[]);h(this,"hexMeshes",[]);h(this,"expansions",[]);h(this,"capitalPlaced",!1);h(this,"conquestInProgress",null);this.scene=o,this.cities=[],this.units=[],this.projectiles=[]}latLngToVector3(o,i,e){const n=(90-o)*(Math.PI/180),s=i*(Math.PI/180),a=e*Math.sin(n)*Math.cos(s),c=e*Math.cos(n),p=e*Math.sin(n)*Math.sin(s);return new T(a,c,p)}async init(){console.log("World.init() started");let o=!1;const i="world-data-v7";try{const e=localStorage.getItem(i);if(e){const n=JSON.parse(e);console.log("Loading world data from localStorage cache (resolution 7)..."),this.buildWorldFromData(n),o=!0}}catch(e){console.warn("Could not load world data from localStorage:",e)}if(!o){console.log("Generating new world with H3 resolution 7...");const e=this.generateWorldData();this.buildWorldFromData(e),this.saveWorldDataToFile(e)}console.log("World.init() completed")}saveWorldDataToFile(o){const i=JSON.stringify(o),e="world-data-v7";try{localStorage.setItem(e,i),console.log("World data cached (H3 resolution 7):",i.length,"bytes")}catch(n){console.warn("Failed to cache world data:",n)}}generateWorldData(){const i=this.globeRadius;console.log("Generating H3 hexagons at resolution",7);const e=new Set,n=2,s=2;for(let l=-85;l<=85;l+=n)for(let g=-180;g<=180;g+=s)try{const y=rt(l,g,7);e.add(y)}catch{}const a=Array.from(e);console.log(`Generated ${a.length} hexagons at H3 resolution 7`);const c=new Map;a.forEach((l,g)=>c.set(l,g));const p=a.map(l=>{const[g,y]=ee(l);return this.latLngToVector3(g,y,i)}),f=a.map(l=>ee(l)[0]),m=a.map(l=>ee(l)[1]),M=a.map(l=>ct(l,1).filter(y=>y!==l).map(y=>c.get(y)).filter(y=>y!==void 0)),w=[],S=[],v=[],L=l=>l-Math.floor(l),x=l=>L(Math.sin(l)*43758.5453123),R=(l,g)=>{const y=.5*(Math.sin(g*.5)*Math.cos(l*.4)+1),u=.3*(Math.sin(g*2.1+10)*Math.cos(l*1.8+5)+1),N=.2*x(g*15.7+l*12.3);let O=y*.5+u*.35+N*.15;const D=Math.abs(l)/90;return O=Math.max(0,Math.min(1,O+D*.15)),Math.max(0,Math.min(1,O))};for(let l=0;l<p.length;l++){const g=f[l],y=m[l],u=R(g,y),N=Math.abs(g)>70;let O="land";if(N)O="pole";else if(u<.4)O="ocean";else if(u<.45)O="coast";else if(u>.75)O="mountain";else{const D=Math.abs(g)>30?.3:0,z=x(y*8.5+g*3.2);O=D+z*.4>.5?"desert":"land"}S[l]=O,v[l]=u,w[l]=O==="ocean"}return{centers:p.map(l=>({x:l.x,y:l.y,z:l.z})),centerNeighbors:M,centerWater:w,centerLat:f,centerLng:m,hexagons:a,biomes:S,elevations:v}}buildWorldFromData(o){this.centers=o.centers.map(m=>new T(m.x,m.y,m.z)),this.centerNeighbors=o.centerNeighbors,this.centerWater=o.centerWater,this.centerLat=o.centerLat,this.centerLng=o.centerLng,this.hexagons=o.hexagons,this.biomes=o.biomes,this.elevations=o.elevations,this.centerOwned=new Array(this.centers.length).fill(!1);const i=new Ze(this.globeRadius,64,32),e=new H({color:1710638,roughness:.9,metalness:0}),n=new K(i,e);n.receiveShadow=!0,n.castShadow=!1,this.globe=n,this.scene.add(n),this.hexMeshes=[];const s=new Ee(6,6,1,6),a={ocean:1982639,coast:6333946,desert:16498468,land:4906624,mountain:7041664,pole:15067115},c=new Map;for(const[m,M]of Object.entries(a))c.set(m,new H({color:M,flatShading:!0,roughness:.8,metalness:0}));console.log(`Building ${this.centers.length} hex meshes...`);const p=performance.now();for(let m=0;m<this.centers.length;m++){const M=this.centers[m],w=this.biomes[m],S=this.elevations[m],L=(c.get(w)||c.get("land")).clone(),x=new K(s,L);x.position.copy(M);const R=M.clone().normalize();x.quaternion.setFromUnitVectors(new T(0,1,0),R);const l=w==="mountain"?1.2+S*.3:1+S*.1;x.scale.y=l,x.castShadow=!1,x.receiveShadow=!1,x.userData={index:m,biome:w},this.scene.add(x),this.hexMeshes.push(x)}const f=performance.now()-p;console.log(`Built ${this.hexMeshes.length} meshes in ${f.toFixed(1)}ms`)}initGame(){console.log("Game Initialized"),this.capitalPlaced=!1}spawnCityAtIndex(o,i){const e=this.centers[o].clone().normalize().multiplyScalar(this.globeRadius+6),n=new Ve(6,8,6),s=new H({color:8947848}),a=new K(n,s);a.position.copy(e),a.quaternion.setFromUnitVectors(new T(0,0,1),e.clone().normalize()),a.castShadow=!0,a.receiveShadow=!0,this.scene.add(a);const c=new Ee(.2,.2,10,6),p=new H({color:2236962}),f=new K(c,p);f.position.copy(e).add(e.clone().normalize().multiplyScalar(6)),f.quaternion.copy(a.quaternion),this.scene.add(f);const m=new Be(6,4),M=new H({color:16724787,side:$e}),w=new K(m,M),S=new T(1,0,0).applyQuaternion(f.quaternion).multiplyScalar(3);w.position.copy(f.position).add(S),w.quaternion.copy(f.quaternion),this.scene.add(w),this.cities.push({mesh:a,name:i,health:100}),this.centerOwned[o]=!0,this.territorySize++;const v=this.hexMeshes[o];v&&v.material.color.set(3368703)}placeCapital(o){if(!o||!o.point||this.capitalPlaced)return!1;const i=o.point;let e=-1,n=1/0;for(let s=0;s<this.centers.length;s++){const a=i.distanceToSquared(this.centers[s]);a<n&&(n=a,e=s)}return e===-1||this.centerWater[e]?!1:(this.capitalPlaced=!0,this.spawnCityAtIndex(e,"Capital"),!0)}isSea(o){let i=null;if(o&&o.point?i=o.point:o instanceof T&&(i=o),!i)return!0;let e=-1,n=1/0;for(let s=0;s<this.centers.length;s++){const a=i.distanceToSquared(this.centers[s]);a<n&&(n=a,e=s)}return e===-1?!0:!!this.centerWater[e]}startExpansion(o,i){if(!o||!o.point||i<=0)return!1;const e=o.point;let n=-1,s=1/0;for(let m=0;m<this.centers.length;m++){const M=e.distanceToSquared(this.centers[m]);M<s&&(s=M,n=m)}if(n===-1||this.centerWater[n]||this.centerOwned[n]||this.centerOwned.some(m=>m)&&!(this.centerNeighbors[n]||[]).some(w=>this.centerOwned[w]))return!1;const c=3,p=Math.min(2,i/100),f=c/p;return this.conquestInProgress={hexIndex:n,troopsAllocated:i,timeElapsed:0,totalTimeNeeded:f},!0}attack(o){console.log("attack called",o)}completeConquest(){if(!this.conquestInProgress)return;const o=this.conquestInProgress.hexIndex;this.centerOwned[o]=!0,this.territorySize++;const i=this.hexMeshes[o];i&&i.material.color.set(3368703),console.log(`Conquered hex ${o} with ${this.conquestInProgress.troopsAllocated} troops`),this.conquestInProgress=null}update(o,i){if(this.conquestInProgress){this.conquestInProgress.timeElapsed+=o;const e=Math.min(1,this.conquestInProgress.timeElapsed/this.conquestInProgress.totalTimeNeeded),n=this.conquestInProgress.hexIndex,s=this.hexMeshes[n];if(s){const a=s.material,c=new Z;c.setHex(4906624),c.lerp(new Z(3368703),e),a.color.copy(c)}this.conquestInProgress.timeElapsed>=this.conquestInProgress.totalTimeNeeded&&this.completeConquest()}for(let e=this.projectiles.length-1;e>=0;e--){const n=this.projectiles[e];if(n.progress+=o*n.speed,n.progress>=1)this.scene.remove(n.mesh),this.projectiles.splice(e,1),n.onComplete&&n.onComplete();else{const s=n.curve.getPoint(n.progress);n.mesh.position.copy(s)}}}destroy(){for(const o of this.hexMeshes){this.scene.remove(o);try{o.geometry.dispose()}catch{}const i=o.material;Array.isArray(i)?i.forEach(e=>e.dispose()):i&&i.dispose()}this.hexMeshes=[],this.globe&&(this.scene.remove(this.globe),this.globe.geometry.dispose(),Array.isArray(this.globe.material)?this.globe.material.forEach(o=>o.dispose()):this.globe.material.dispose(),this.globe=null)}}class bt{constructor(o,i,e){h(this,"domElement");h(this,"camera");h(this,"scene");h(this,"raycaster");h(this,"mouse");this.domElement=o,this.camera=i,this.scene=e,this.raycaster=new Qe,this.mouse=new A,this.domElement.addEventListener("mousemove",n=>this.onMouseMove(n)),this.domElement.addEventListener("click",()=>this.onClick())}onMouseMove(o){this.mouse.x=o.clientX/window.innerWidth*2-1,this.mouse.y=-(o.clientY/window.innerHeight)*2+1}onClick(){this.raycaster.setFromCamera(this.mouse,this.camera)}getIntersection(){this.raycaster.setFromCamera(this.mouse,this.camera);const o=this.raycaster.intersectObjects(this.scene.children,!0);return o.length>0?o[0]:null}}class yt{constructor(){h(this,"isConnected");this.isConnected=!1}connect(o){console.log(`Connecting to ${o}...`),this.isConnected=!0}}const U=Ke(d=>({isGamePaused:!1,cash:25e4,troops:500,theme:"light",togglePause:()=>d(o=>({isGamePaused:!o.isGamePaused})),updateStats:o=>d(i=>({cash:o.cash??i.cash,troops:o.troops??i.troops})),toggleTheme:()=>d(o=>({theme:o.theme==="light"?"dark":"light"}))}));class wt{constructor(o){h(this,"container");h(this,"width");h(this,"height");h(this,"scene");h(this,"camera");h(this,"renderer");h(this,"controls");h(this,"inputManager");h(this,"networkManager");h(this,"world",null);h(this,"isRunning");h(this,"money",25e4);h(this,"troops",500);h(this,"troopTimer",0);h(this,"gameActive",!1);h(this,"stars",null);this.container=o||document.getElementById("app")||document.body,this.width=window.innerWidth,this.height=window.innerHeight,this.scene=new Je,this.scene.background=new Z(1710638),this.camera=new et(60,this.width/this.height,.1,1e3),this.renderer=new tt({antialias:!0}),this.renderer.setSize(this.width,this.height),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!1,this.container.appendChild(this.renderer.domElement);const i=new ot(16777215,.8);this.scene.add(i),this.camera.position.set(0,200,400),this.camera.lookAt(0,0,0),this.controls=new ft(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.minDistance=220,this.controls.maxDistance=800,this.controls.autoRotate=!0,this.controls.autoRotateSpeed=2,this.inputManager=new bt(this.renderer.domElement,this.camera,this.scene),this.networkManager=new yt,this.createStars(),this.isRunning=!1,window.addEventListener("resize",()=>this.onWindowResize(),!1),this.inputManager.domElement.addEventListener("click",()=>this.onMouseClick()),U.subscribe(e=>this.updateTheme(e.theme)),this.start()}async initWorld(){this.world=new gt(this.scene),await this.world.init()}createStars(){const o=new nt,i=2e3,e=new Float32Array(i*3);for(let s=0;s<i*3;s++)e[s]=(Math.random()-.5)*2e3;o.setAttribute("position",new st(e,3));const n=new it({size:2,color:16777215});this.stars=new at(o,n),this.stars.visible=!1,this.scene.add(this.stars)}updateTheme(o){const i=o==="dark";this.scene.background=new Z(i?328965:8900331),this.stars&&(this.stars.visible=i)}start(){this.isRunning=!0,this.renderer.setAnimationLoop(()=>this.loop())}activateGame(){this.gameActive=!0,this.controls.autoRotate=!1}loop(){if(this.controls.update(),this.world.update(.016,this.gameActive),this.gameActive&&(this.troopTimer+=.016,this.troopTimer>=1)){const i=this.world.cities.length+Math.floor(this.world.territorySize*.01);this.troops+=Math.max(1,i),this.troopTimer=0}U.getState().updateStats({troops:this.troops,cash:this.money}),this.renderer.render(this.scene,this.camera)}onMouseClick(){const o=this.inputManager.getIntersection();if(o&&o.point)if(this.gameActive){const i=Math.floor(this.troops*.2);i>0&&(this.troops-=i,this.world.attack(o))}else{if(!this.world.capitalPlaced&&this.world.placeCapital(o)){this.activateGame();return}const i=Math.floor(this.troops*.5);i>0&&this.world.startExpansion(o,i)&&(this.troops-=i,console.log(`Sent ${i} troops to conquer. Remaining: ${this.troops}`))}}onWindowResize(){this.width=window.innerWidth,this.height=window.innerHeight,this.camera.aspect=this.width/this.height,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.width,this.height)}}const xt=({onStartGame:d})=>{const[o,i]=C.useState("Player"),{theme:e,toggleTheme:n}=U(),s=()=>{o.trim()&&d(o.trim())};return b.jsxs("div",{className:"main-menu-screen",children:[b.jsx("button",{className:"theme-toggle",onClick:n,title:"Toggle Theme",children:e==="dark"?"â˜€ï¸":"ðŸŒ™"}),b.jsxs("div",{className:"main-menu-content",children:[b.jsx("h1",{className:"game-title",children:"Sketchi"}),b.jsxs("div",{className:"nametag-container",children:[b.jsx("label",{htmlFor:"nametag",children:"Nametag"}),b.jsx("input",{id:"nametag",type:"text",value:o,onChange:a=>i(a.target.value)})]}),b.jsx("button",{className:"menu-button",onClick:s,children:"Singleplayer"})]})]})},Et=({game:d})=>{const{cash:o,troops:i,theme:e}=U(),[n,s]=C.useState({visible:!1,x:0,y:0,intersection:null});C.useEffect(()=>{const c=f=>{f.preventDefault();const m=d.inputManager.getIntersection();m&&m.point&&s({visible:!0,x:f.clientX,y:f.clientY,intersection:m})},p=()=>{n.visible&&s(f=>({...f,visible:!1}))};return d.renderer.domElement.addEventListener("contextmenu",c),window.addEventListener("click",p),()=>{d.renderer.domElement.removeEventListener("contextmenu",c),window.removeEventListener("click",p)}},[d,n.visible]);const a=c=>{if(n.intersection){if(c==="attack"){if(d.world.isSea&&d.world.isSea(n.intersection)){console.log("Cannot expand over sea!"),s(f=>({...f,visible:!1}));return}const p=Math.max(1,i*.02);d.world.startExpansion(n.intersection,p),console.log("Expanding at",n.intersection,"with speed",p)}else if(c==="build"){if(d.world.isSea&&d.world.isSea(n.intersection)){console.log("Cannot place capital in the ocean!"),s(p=>({...p,visible:!1}));return}if(d.world.placeCapital){const p=d.world.placeCapital(n.intersection);console.log("Place capital result:",p)}else console.log("World does not support placeCapital().")}s(p=>({...p,visible:!1}))}};return b.jsxs(b.Fragment,{children:[b.jsxs("div",{id:"resource-display",style:{position:"absolute",top:"20px",left:"20px",display:"flex",flexDirection:"column",gap:"10px",color:e==="dark"?"white":"black",fontFamily:"sans-serif",fontWeight:"bold",fontSize:"20px",textShadow:"0 0 5px rgba(0,0,0,0.5)"},children:[b.jsxs("div",{id:"money-counter",children:["ðŸ’° ",Math.floor(o).toLocaleString()]}),b.jsxs("div",{id:"troop-counter",children:["âš”ï¸ ",Math.floor(i).toLocaleString()]})]}),b.jsx("div",{id:"game-hud"}),n.visible&&b.jsxs("div",{id:"context-menu",style:{position:"absolute",top:n.y,left:n.x,width:"150px",height:"150px",transform:"translate(-50%, -50%)",zIndex:1e3,pointerEvents:"none",borderRadius:"50%",background:"rgba(0, 0, 0, 0.2)"},children:[b.jsx("button",{onClick:()=>a("attack"),style:{position:"absolute",top:"0",left:"50%",transform:"translateX(-50%)",width:"60px",height:"60px",borderRadius:"50%",background:"#ff4757",color:"white",border:"2px solid white",cursor:"pointer",pointerEvents:"auto",boxShadow:"0 4px 10px rgba(0,0,0,0.3)"},children:"âš”ï¸"}),b.jsx("button",{onClick:()=>a("build"),style:{position:"absolute",bottom:"0",left:"50%",transform:"translateX(-50%)",width:"60px",height:"60px",borderRadius:"50%",background:"#2ed573",color:"white",border:"2px solid white",cursor:"pointer",pointerEvents:"auto",boxShadow:"0 4px 10px rgba(0,0,0,0.3)"},children:"ðŸš©"})]})]})};function Mt(){const[d,o]=C.useState(!1),[i,e]=C.useState(!1),{theme:n}=U(),s=C.useRef(null),a=C.useRef(null),c=p=>{console.log(`Starting game for ${p}`),o(!0),s.current&&s.current.activateGame()};return C.useEffect(()=>((async()=>{if(a.current&&!s.current)try{console.log("Initializing game...");const f=new wt(a.current);console.log("Created Game instance"),console.log("Starting world initialization..."),await f.initWorld(),console.log("World initialized successfully"),console.log("Starting game loop..."),f.start(),console.log("Game started"),s.current=f,e(!0),console.log("Game is ready!")}catch(f){console.error("Failed to initialize game:",f),e(!1)}})(),()=>{s.current&&a.current&&(a.current.innerHTML="",s.current=null,e(!1))}),[]),b.jsxs("div",{style:{width:"100vw",height:"100vh",background:n==="dark"?"#333":"#f0f0f0",position:"relative",overflow:"hidden"},children:[b.jsx("div",{ref:a,style:{width:"100%",height:"100%",position:"absolute",top:0,left:0,zIndex:0}}),!d&&b.jsx(xt,{onStartGame:c}),d&&i&&s.current&&b.jsx(Et,{game:s.current})]})}oe.createRoot(document.getElementById("app")).render(b.jsx(Mt,{}));
