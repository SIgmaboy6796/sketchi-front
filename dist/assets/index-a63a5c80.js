var qe=Object.defineProperty;var Ye=(u,n,i)=>n in u?qe(u,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):u[n]=i;var h=(u,n,i)=>(Ye(u,typeof n!="symbol"?n+"":n,i),i);import{r as k,c as Ue}from"./zustand-ebf5350a.js";import{r as Ke}from"./react-0138d7aa.js";import{E as Xe,V as M,M as G,T as W,Q as we,S as xe,a as I,b as Ze,c as U,d as Z,C as Ee,I as Be,D as Ve,O as $e,e as z,f as Qe,B as Je,P as et,g as tt,R as nt,h as ot,i as st,W as it,A as at,j as rt,k as ct,l as lt,m as ht}from"./three-8534ff9b.js";import{l as dt,c as ee,g as ut}from"./h3-js-16254e39.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))e(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function i(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function e(o){if(o.ep)return;o.ep=!0;const s=i(o);fetch(o.href,s)}})();var Te={exports:{}},B={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var pt=k,mt=Symbol.for("react.element"),ft=Symbol.for("react.fragment"),gt=Object.prototype.hasOwnProperty,yt=pt.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,bt={key:!0,ref:!0,__self:!0,__source:!0};function ve(u,n,i){var e,o={},s=null,a=null;i!==void 0&&(s=""+i),n.key!==void 0&&(s=""+n.key),n.ref!==void 0&&(a=n.ref);for(e in n)gt.call(n,e)&&!bt.hasOwnProperty(e)&&(o[e]=n[e]);if(u&&u.defaultProps)for(e in n=u.defaultProps,n)o[e]===void 0&&(o[e]=n[e]);return{$$typeof:mt,type:u,key:s,ref:a,props:o,_owner:yt.current}}B.Fragment=ft;B.jsx=ve;B.jsxs=ve;Te.exports=B;var b=Te.exports,ne={},Me=Ke;ne.createRoot=Me.createRoot,ne.hydrateRoot=Me.hydrateRoot;const Pe={type:"change"},te={type:"start"},Se={type:"end"};class wt extends Xe{constructor(n,i){super(),this.object=n,this.domElement=i,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new M,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:G.ROTATE,MIDDLE:G.DOLLY,RIGHT:G.PAN},this.touches={ONE:W.ROTATE,TWO:W.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return d.phi},this.getAzimuthalAngle=function(){return d.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(t){t.addEventListener("keydown",Q),this._domElementKeyEvents=t},this.stopListenToKeyEvents=function(){this._domElementKeyEvents.removeEventListener("keydown",Q),this._domElementKeyEvents=null},this.saveState=function(){e.target0.copy(e.target),e.position0.copy(e.object.position),e.zoom0=e.object.zoom},this.reset=function(){e.target.copy(e.target0),e.object.position.copy(e.position0),e.object.zoom=e.zoom0,e.object.updateProjectionMatrix(),e.dispatchEvent(Pe),e.update(),s=o.NONE},this.update=function(){const t=new M,r=new we().setFromUnitVectors(n.up,new M(0,1,0)),x=r.clone().invert(),E=new M,A=new we,X=new M,H=2*Math.PI;return function(){const be=e.object.position;t.copy(be).sub(e.target),t.applyQuaternion(r),d.setFromVector3(t),e.autoRotate&&s===o.NONE&&_(v()),e.enableDamping?(d.theta+=l.theta*e.dampingFactor,d.phi+=l.phi*e.dampingFactor):(d.theta+=l.theta,d.phi+=l.phi);let R=e.minAzimuthAngle,j=e.maxAzimuthAngle;return isFinite(R)&&isFinite(j)&&(R<-Math.PI?R+=H:R>Math.PI&&(R-=H),j<-Math.PI?j+=H:j>Math.PI&&(j-=H),R<=j?d.theta=Math.max(R,Math.min(j,d.theta)):d.theta=d.theta>(R+j)/2?Math.max(R,d.theta):Math.min(j,d.theta)),d.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,d.phi)),d.makeSafe(),d.radius*=m,d.radius=Math.max(e.minDistance,Math.min(e.maxDistance,d.radius)),e.enableDamping===!0?e.target.addScaledVector(g,e.dampingFactor):e.target.add(g),t.setFromSpherical(d),t.applyQuaternion(x),be.copy(e.target).add(t),e.object.lookAt(e.target),e.enableDamping===!0?(l.theta*=1-e.dampingFactor,l.phi*=1-e.dampingFactor,g.multiplyScalar(1-e.dampingFactor)):(l.set(0,0,0),g.set(0,0,0)),m=1,P||E.distanceToSquared(e.object.position)>a||8*(1-A.dot(e.object.quaternion))>a||X.distanceToSquared(e.target)>0?(e.dispatchEvent(Pe),E.copy(e.object.position),A.copy(e.object.quaternion),X.copy(e.target),P=!1,!0):!1}}(),this.dispose=function(){e.domElement.removeEventListener("contextmenu",ge),e.domElement.removeEventListener("pointerdown",me),e.domElement.removeEventListener("pointercancel",Y),e.domElement.removeEventListener("wheel",fe),e.domElement.removeEventListener("pointermove",$),e.domElement.removeEventListener("pointerup",Y),e._domElementKeyEvents!==null&&(e._domElementKeyEvents.removeEventListener("keydown",Q),e._domElementKeyEvents=null)};const e=this,o={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let s=o.NONE;const a=1e-6,d=new xe,l=new xe;let m=1;const g=new M;let P=!1;const f=new I,S=new I,O=new I,C=new I,T=new I,L=new I,c=new I,y=new I,w=new I,p=[],D={};function v(){return 2*Math.PI/60/60*e.autoRotateSpeed}function N(){return Math.pow(.95,e.zoomSpeed)}function _(t){l.theta-=t}function q(t){l.phi-=t}const oe=function(){const t=new M;return function(x,E){t.setFromMatrixColumn(E,0),t.multiplyScalar(-x),g.add(t)}}(),se=function(){const t=new M;return function(x,E){e.screenSpacePanning===!0?t.setFromMatrixColumn(E,1):(t.setFromMatrixColumn(E,0),t.crossVectors(e.object.up,t)),t.multiplyScalar(x),g.add(t)}}(),F=function(){const t=new M;return function(x,E){const A=e.domElement;if(e.object.isPerspectiveCamera){const X=e.object.position;t.copy(X).sub(e.target);let H=t.length();H*=Math.tan(e.object.fov/2*Math.PI/180),oe(2*x*H/A.clientHeight,e.object.matrix),se(2*E*H/A.clientHeight,e.object.matrix)}else e.object.isOrthographicCamera?(oe(x*(e.object.right-e.object.left)/e.object.zoom/A.clientWidth,e.object.matrix),se(E*(e.object.top-e.object.bottom)/e.object.zoom/A.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),e.enablePan=!1)}}();function V(t){e.object.isPerspectiveCamera?m/=t:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom*t)),e.object.updateProjectionMatrix(),P=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function ie(t){e.object.isPerspectiveCamera?m*=t:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/t)),e.object.updateProjectionMatrix(),P=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function ae(t){f.set(t.clientX,t.clientY)}function Oe(t){c.set(t.clientX,t.clientY)}function re(t){C.set(t.clientX,t.clientY)}function Ce(t){S.set(t.clientX,t.clientY),O.subVectors(S,f).multiplyScalar(e.rotateSpeed);const r=e.domElement;_(2*Math.PI*O.x/r.clientHeight),q(2*Math.PI*O.y/r.clientHeight),f.copy(S),e.update()}function Le(t){y.set(t.clientX,t.clientY),w.subVectors(y,c),w.y>0?V(N()):w.y<0&&ie(N()),c.copy(y),e.update()}function Ae(t){T.set(t.clientX,t.clientY),L.subVectors(T,C).multiplyScalar(e.panSpeed),F(L.x,L.y),C.copy(T),e.update()}function Ie(t){t.deltaY<0?ie(N()):t.deltaY>0&&V(N()),e.update()}function Re(t){let r=!1;switch(t.code){case e.keys.UP:t.ctrlKey||t.metaKey||t.shiftKey?q(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):F(0,e.keyPanSpeed),r=!0;break;case e.keys.BOTTOM:t.ctrlKey||t.metaKey||t.shiftKey?q(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):F(0,-e.keyPanSpeed),r=!0;break;case e.keys.LEFT:t.ctrlKey||t.metaKey||t.shiftKey?_(2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):F(e.keyPanSpeed,0),r=!0;break;case e.keys.RIGHT:t.ctrlKey||t.metaKey||t.shiftKey?_(-2*Math.PI*e.rotateSpeed/e.domElement.clientHeight):F(-e.keyPanSpeed,0),r=!0;break}r&&(t.preventDefault(),e.update())}function ce(){if(p.length===1)f.set(p[0].pageX,p[0].pageY);else{const t=.5*(p[0].pageX+p[1].pageX),r=.5*(p[0].pageY+p[1].pageY);f.set(t,r)}}function le(){if(p.length===1)C.set(p[0].pageX,p[0].pageY);else{const t=.5*(p[0].pageX+p[1].pageX),r=.5*(p[0].pageY+p[1].pageY);C.set(t,r)}}function he(){const t=p[0].pageX-p[1].pageX,r=p[0].pageY-p[1].pageY,x=Math.sqrt(t*t+r*r);c.set(0,x)}function je(){e.enableZoom&&he(),e.enablePan&&le()}function ke(){e.enableZoom&&he(),e.enableRotate&&ce()}function de(t){if(p.length==1)S.set(t.pageX,t.pageY);else{const x=J(t),E=.5*(t.pageX+x.x),A=.5*(t.pageY+x.y);S.set(E,A)}O.subVectors(S,f).multiplyScalar(e.rotateSpeed);const r=e.domElement;_(2*Math.PI*O.x/r.clientHeight),q(2*Math.PI*O.y/r.clientHeight),f.copy(S)}function ue(t){if(p.length===1)T.set(t.pageX,t.pageY);else{const r=J(t),x=.5*(t.pageX+r.x),E=.5*(t.pageY+r.y);T.set(x,E)}L.subVectors(T,C).multiplyScalar(e.panSpeed),F(L.x,L.y),C.copy(T)}function pe(t){const r=J(t),x=t.pageX-r.x,E=t.pageY-r.y,A=Math.sqrt(x*x+E*E);y.set(0,A),w.set(0,Math.pow(y.y/c.y,e.zoomSpeed)),V(w.y),c.copy(y)}function De(t){e.enableZoom&&pe(t),e.enablePan&&ue(t)}function Ne(t){e.enableZoom&&pe(t),e.enableRotate&&de(t)}function me(t){e.enabled!==!1&&(p.length===0&&(e.domElement.setPointerCapture(t.pointerId),e.domElement.addEventListener("pointermove",$),e.domElement.addEventListener("pointerup",Y)),Ge(t),t.pointerType==="touch"?ze(t):He(t))}function $(t){e.enabled!==!1&&(t.pointerType==="touch"?Fe(t):_e(t))}function Y(t){We(t),p.length===0&&(e.domElement.releasePointerCapture(t.pointerId),e.domElement.removeEventListener("pointermove",$),e.domElement.removeEventListener("pointerup",Y)),e.dispatchEvent(Se),s=o.NONE}function He(t){let r;switch(t.button){case 0:r=e.mouseButtons.LEFT;break;case 1:r=e.mouseButtons.MIDDLE;break;case 2:r=e.mouseButtons.RIGHT;break;default:r=-1}switch(r){case G.DOLLY:if(e.enableZoom===!1)return;Oe(t),s=o.DOLLY;break;case G.ROTATE:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enablePan===!1)return;re(t),s=o.PAN}else{if(e.enableRotate===!1)return;ae(t),s=o.ROTATE}break;case G.PAN:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enableRotate===!1)return;ae(t),s=o.ROTATE}else{if(e.enablePan===!1)return;re(t),s=o.PAN}break;default:s=o.NONE}s!==o.NONE&&e.dispatchEvent(te)}function _e(t){switch(s){case o.ROTATE:if(e.enableRotate===!1)return;Ce(t);break;case o.DOLLY:if(e.enableZoom===!1)return;Le(t);break;case o.PAN:if(e.enablePan===!1)return;Ae(t);break}}function fe(t){e.enabled===!1||e.enableZoom===!1||s!==o.NONE||(t.preventDefault(),e.dispatchEvent(te),Ie(t),e.dispatchEvent(Se))}function Q(t){e.enabled===!1||e.enablePan===!1||Re(t)}function ze(t){switch(ye(t),p.length){case 1:switch(e.touches.ONE){case W.ROTATE:if(e.enableRotate===!1)return;ce(),s=o.TOUCH_ROTATE;break;case W.PAN:if(e.enablePan===!1)return;le(),s=o.TOUCH_PAN;break;default:s=o.NONE}break;case 2:switch(e.touches.TWO){case W.DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;je(),s=o.TOUCH_DOLLY_PAN;break;case W.DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;ke(),s=o.TOUCH_DOLLY_ROTATE;break;default:s=o.NONE}break;default:s=o.NONE}s!==o.NONE&&e.dispatchEvent(te)}function Fe(t){switch(ye(t),s){case o.TOUCH_ROTATE:if(e.enableRotate===!1)return;de(t),e.update();break;case o.TOUCH_PAN:if(e.enablePan===!1)return;ue(t),e.update();break;case o.TOUCH_DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;De(t),e.update();break;case o.TOUCH_DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;Ne(t),e.update();break;default:s=o.NONE}}function ge(t){e.enabled!==!1&&t.preventDefault()}function Ge(t){p.push(t)}function We(t){delete D[t.pointerId];for(let r=0;r<p.length;r++)if(p[r].pointerId==t.pointerId){p.splice(r,1);return}}function ye(t){let r=D[t.pointerId];r===void 0&&(r=new I,D[t.pointerId]=r),r.set(t.pageX,t.pageY)}function J(t){const r=t.pointerId===p[0].pointerId?p[1]:p[0];return D[r.pointerId]}e.domElement.addEventListener("contextmenu",ge),e.domElement.addEventListener("pointerdown",me),e.domElement.addEventListener("pointercancel",Y),e.domElement.addEventListener("wheel",fe,{passive:!1}),this.update()}}class xt{constructor(n){h(this,"scene");h(this,"cities");h(this,"units");h(this,"projectiles");h(this,"globe",null);h(this,"globeRadius",210);h(this,"territorySize",0);h(this,"centers",[]);h(this,"centerNeighbors",[]);h(this,"centerWater",[]);h(this,"centerOwned",[]);h(this,"centerLat",[]);h(this,"centerLng",[]);h(this,"hexagons",[]);h(this,"biomes",[]);h(this,"elevations",[]);h(this,"hexMeshes",[]);h(this,"expansions",[]);h(this,"capitalPlaced",!1);h(this,"conquestInProgress",null);h(this,"instancedHexMesh",null);this.scene=n,this.cities=[],this.units=[],this.projectiles=[]}getBiomeColor(n){switch(n){case"ocean":return 1982639;case"coast":return 6333946;case"desert":return 16498468;case"land":return 4906624;case"mountain":return 7041664;case"pole":return 15067115;default:return 4906624}}latLngToVector3(n,i,e){const o=(90-n)*(Math.PI/180),s=i*(Math.PI/180),a=e*Math.sin(o)*Math.cos(s),d=e*Math.cos(o),l=e*Math.sin(o)*Math.sin(s);return new M(a,d,l)}async init(){console.log("World.init() started");let n=!1;const i="world-data-v7";try{const e=localStorage.getItem(i);if(e){const o=JSON.parse(e);console.log("Loading world data from localStorage cache (resolution 7)..."),this.buildWorldFromData(o),n=!0}}catch(e){console.warn("Could not load world data from localStorage:",e)}if(!n){console.log("Generating new world with H3 resolution 7...");const e=this.generateWorldData();this.buildWorldFromData(e),this.saveWorldDataToFile(e)}console.log("World.init() completed")}saveWorldDataToFile(n){const i=JSON.stringify(n),e="world-data-v7";try{localStorage.setItem(e,i),console.log("World data cached (H3 resolution 7):",i.length,"bytes")}catch(o){console.warn("Failed to cache world data:",o)}}generateWorldData(){const i=this.globeRadius;console.log("Generating H3 hexagons at resolution",7);const e=new Set,o=2,s=2;for(let c=-85;c<=85;c+=o)for(let y=-180;y<=180;y+=s)try{const w=dt(c,y,7);e.add(w)}catch{}const a=Array.from(e);console.log(`Generated ${a.length} hexagons at H3 resolution 7`);const d=new Map;a.forEach((c,y)=>d.set(c,y));const l=a.map(c=>{const[y,w]=ee(c);return this.latLngToVector3(y,w,i)}),m=a.map(c=>ee(c)[0]),g=a.map(c=>ee(c)[1]),P=a.map(c=>ut(c,1).filter(w=>w!==c).map(w=>d.get(w)).filter(w=>w!==void 0)),f=[],S=[],O=[],C=c=>c-Math.floor(c),T=c=>C(Math.sin(c)*43758.5453123),L=(c,y)=>{const w=.5*(Math.sin(y*.5)*Math.cos(c*.4)+1),p=.3*(Math.sin(y*2.1+10)*Math.cos(c*1.8+5)+1),D=.2*T(y*15.7+c*12.3);let v=w*.5+p*.35+D*.15;const N=Math.abs(c)/90;return v=Math.max(0,Math.min(1,v+N*.15)),Math.max(0,Math.min(1,v))};for(let c=0;c<l.length;c++){const y=m[c],w=g[c],p=L(y,w),D=Math.abs(y)>70;let v="land";if(D)v="pole";else if(p<.4)v="ocean";else if(p<.45)v="coast";else if(p>.75)v="mountain";else{const N=Math.abs(y)>30?.3:0,_=T(w*8.5+y*3.2);v=N+_*.4>.5?"desert":"land"}S[c]=v,O[c]=p,f[c]=v==="ocean"}return{centers:l.map(c=>({x:c.x,y:c.y,z:c.z})),centerNeighbors:P,centerWater:f,centerLat:m,centerLng:g,hexagons:a,biomes:S,elevations:O}}buildWorldFromData(n){this.centers=n.centers.map(f=>new M(f.x,f.y,f.z)),this.centerNeighbors=n.centerNeighbors,this.centerWater=n.centerWater,this.centerLat=n.centerLat,this.centerLng=n.centerLng,this.hexagons=n.hexagons,this.biomes=n.biomes,this.elevations=n.elevations,this.centerOwned=new Array(this.centers.length).fill(!1);const i=new Ze(this.globeRadius,64,32),e=new U({color:1710638,roughness:.9,metalness:0}),o=new Z(i,e);o.receiveShadow=!0,o.castShadow=!1,this.globe=o,this.scene.add(o),this.hexMeshes=[];const s=new Ee(6,6,1,6),a=new U({flatShading:!0,roughness:.8,metalness:0,vertexColors:!0}),d=this.centers.length,l=new Be(s,a,d);l.instanceMatrix.setUsage(Ve);const m=new $e,g=new z,P=.2;for(let f=0;f<d;f++){const S=this.centers[f],O=this.biomes[f],C=this.elevations[f],T=S.clone().normalize(),L=O==="mountain"?1.2+C*.3:1+C*.1,c=T.clone().multiplyScalar(this.globeRadius+L*.5+P);m.position.copy(c),m.quaternion.setFromUnitVectors(new M(0,1,0),T),m.scale.set(1,L,1),m.updateMatrix(),l.setMatrixAt(f,m.matrix),g.setHex(this.getBiomeColor(O)),l.instanceColor||(l.instanceColor=new Qe(new Float32Array(d*3),3)),l.setColorAt(f,g)}l.instanceMatrix.needsUpdate=!0,l.instanceColor&&(l.instanceColor.needsUpdate=!0),this.instancedHexMesh=l,this.scene.add(l),console.log(`Built instanced mesh with ${d} instances`)}initGame(){console.log("Game Initialized"),this.capitalPlaced=!1}spawnCityAtIndex(n,i){const e=this.centers[n].clone().normalize().multiplyScalar(this.globeRadius+6),o=new Je(6,8,6),s=new U({color:8947848}),a=new Z(o,s);a.position.copy(e),a.quaternion.setFromUnitVectors(new M(0,0,1),e.clone().normalize()),a.castShadow=!0,a.receiveShadow=!0,this.scene.add(a);const d=new Ee(.2,.2,10,6),l=new U({color:2236962}),m=new Z(d,l);m.position.copy(e).add(e.clone().normalize().multiplyScalar(6)),m.quaternion.copy(a.quaternion),this.scene.add(m);const g=new et(6,4),P=new U({color:16724787,side:tt}),f=new Z(g,P),S=new M(1,0,0).applyQuaternion(m.quaternion).multiplyScalar(3);f.position.copy(m.position).add(S),f.quaternion.copy(m.quaternion),this.scene.add(f),this.cities.push({mesh:a,name:i,health:100}),this.centerOwned[n]=!0,this.territorySize++,this.instancedHexMesh&&(this.instancedHexMesh.setColorAt(n,new z(3368703)),this.instancedHexMesh.instanceColor&&(this.instancedHexMesh.instanceColor.needsUpdate=!0))}placeCapital(n){if(!n||!n.point||this.capitalPlaced)return!1;const i=n.point;let e=-1,o=1/0;for(let s=0;s<this.centers.length;s++){const a=i.distanceToSquared(this.centers[s]);a<o&&(o=a,e=s)}return e===-1||this.centerWater[e]?!1:(this.capitalPlaced=!0,this.spawnCityAtIndex(e,"Capital"),!0)}isSea(n){let i=null;if(n&&n.point?i=n.point:n instanceof M&&(i=n),!i)return!0;let e=-1,o=1/0;for(let s=0;s<this.centers.length;s++){const a=i.distanceToSquared(this.centers[s]);a<o&&(o=a,e=s)}return e===-1?!0:!!this.centerWater[e]}startExpansion(n,i){if(!n||!n.point||i<=0)return!1;const e=n.point;let o=-1,s=1/0;for(let g=0;g<this.centers.length;g++){const P=e.distanceToSquared(this.centers[g]);P<s&&(s=P,o=g)}if(o===-1||this.centerWater[o]||this.centerOwned[o]||this.centerOwned.some(g=>g)&&!(this.centerNeighbors[o]||[]).some(f=>this.centerOwned[f]))return!1;const d=3,l=Math.min(2,i/100),m=d/l;return this.conquestInProgress={hexIndex:o,troopsAllocated:i,timeElapsed:0,totalTimeNeeded:m},!0}attack(n){console.log("attack called",n)}completeConquest(){if(!this.conquestInProgress)return;const n=this.conquestInProgress.hexIndex;this.centerOwned[n]=!0,this.territorySize++,this.instancedHexMesh&&(this.instancedHexMesh.setColorAt(n,new z(3368703)),this.instancedHexMesh.instanceColor&&(this.instancedHexMesh.instanceColor.needsUpdate=!0)),console.log(`Conquered hex ${n} with ${this.conquestInProgress.troopsAllocated} troops`),this.conquestInProgress=null}update(n,i){if(this.conquestInProgress){this.conquestInProgress.timeElapsed+=n;const e=Math.min(1,this.conquestInProgress.timeElapsed/this.conquestInProgress.totalTimeNeeded),o=this.conquestInProgress.hexIndex;if(this.instancedHexMesh){const s=this.getBiomeColor(this.biomes[o]),a=new z(s);a.lerp(new z(3368703),e),this.instancedHexMesh.setColorAt(o,a),this.instancedHexMesh.instanceColor&&(this.instancedHexMesh.instanceColor.needsUpdate=!0)}this.conquestInProgress.timeElapsed>=this.conquestInProgress.totalTimeNeeded&&this.completeConquest()}for(let e=this.projectiles.length-1;e>=0;e--){const o=this.projectiles[e];if(o.progress+=n*o.speed,o.progress>=1)this.scene.remove(o.mesh),this.projectiles.splice(e,1),o.onComplete&&o.onComplete();else{const s=o.curve.getPoint(o.progress);o.mesh.position.copy(s)}}}destroy(){if(this.instancedHexMesh){this.scene.remove(this.instancedHexMesh);try{this.instancedHexMesh.geometry.dispose()}catch{}try{this.instancedHexMesh.material.dispose()}catch{}this.instancedHexMesh=null}this.hexMeshes=[],this.globe&&(this.scene.remove(this.globe),this.globe.geometry.dispose(),Array.isArray(this.globe.material)?this.globe.material.forEach(n=>n.dispose()):this.globe.material.dispose(),this.globe=null)}}class Et{constructor(n,i,e){h(this,"domElement");h(this,"camera");h(this,"scene");h(this,"raycaster");h(this,"mouse");this.domElement=n,this.camera=i,this.scene=e,this.raycaster=new nt,this.mouse=new I,this.domElement.addEventListener("mousemove",o=>this.onMouseMove(o)),this.domElement.addEventListener("click",()=>this.onClick())}onMouseMove(n){this.mouse.x=n.clientX/window.innerWidth*2-1,this.mouse.y=-(n.clientY/window.innerHeight)*2+1}onClick(){this.raycaster.setFromCamera(this.mouse,this.camera)}getIntersection(){this.raycaster.setFromCamera(this.mouse,this.camera);const n=this.raycaster.intersectObjects(this.scene.children,!0);return n.length>0?n[0]:null}}class Mt{constructor(){h(this,"isConnected");this.isConnected=!1}connect(n){console.log(`Connecting to ${n}...`),this.isConnected=!0}}const K=Ue(u=>({isGamePaused:!1,cash:25e4,troops:500,theme:"light",togglePause:()=>u(n=>({isGamePaused:!n.isGamePaused})),updateStats:n=>u(i=>({cash:n.cash??i.cash,troops:n.troops??i.troops})),toggleTheme:()=>u(n=>({theme:n.theme==="light"?"dark":"light"}))}));class Pt{constructor(n){h(this,"container");h(this,"width");h(this,"height");h(this,"scene");h(this,"camera");h(this,"renderer");h(this,"controls");h(this,"inputManager");h(this,"networkManager");h(this,"world",null);h(this,"isRunning");h(this,"money",25e4);h(this,"troops",500);h(this,"troopTimer",0);h(this,"gameActive",!1);h(this,"stars",null);this.container=n||document.getElementById("app")||document.body,this.width=window.innerWidth,this.height=window.innerHeight,this.scene=new ot,this.scene.background=new z(1710638),this.camera=new st(60,this.width/this.height,.1,1e3),this.renderer=new it({antialias:!0}),this.renderer.setSize(this.width,this.height),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!1,this.container.appendChild(this.renderer.domElement);const i=new at(16777215,.8);this.scene.add(i),this.camera.position.set(0,200,400),this.camera.lookAt(0,0,0),this.controls=new wt(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.minDistance=220,this.controls.maxDistance=800,this.controls.autoRotate=!0,this.controls.autoRotateSpeed=2,this.inputManager=new Et(this.renderer.domElement,this.camera,this.scene),this.networkManager=new Mt,this.createStars(),this.isRunning=!1,window.addEventListener("resize",()=>this.onWindowResize(),!1),this.inputManager.domElement.addEventListener("click",()=>this.onMouseClick()),K.subscribe(e=>this.updateTheme(e.theme)),this.start()}async initWorld(){this.world=new xt(this.scene),await this.world.init()}createStars(){const n=new rt,i=2e3,e=new Float32Array(i*3);for(let s=0;s<i*3;s++)e[s]=(Math.random()-.5)*2e3;n.setAttribute("position",new ct(e,3));const o=new lt({size:2,color:16777215});this.stars=new ht(n,o),this.stars.visible=!1,this.scene.add(this.stars)}updateTheme(n){const i=n==="dark";this.scene.background=new z(i?328965:8900331),this.stars&&(this.stars.visible=i)}start(){this.isRunning=!0,this.renderer.setAnimationLoop(()=>this.loop())}activateGame(){this.gameActive=!0,this.controls.autoRotate=!1}loop(){if(this.controls.update(),this.world.update(.016,this.gameActive),this.gameActive&&(this.troopTimer+=.016,this.troopTimer>=1)){const i=this.world.cities.length+Math.floor(this.world.territorySize*.01);this.troops+=Math.max(1,i),this.troopTimer=0}K.getState().updateStats({troops:this.troops,cash:this.money}),this.renderer.render(this.scene,this.camera)}onMouseClick(){const n=this.inputManager.getIntersection();if(n&&n.point)if(this.gameActive){const i=Math.floor(this.troops*.2);i>0&&(this.troops-=i,this.world.attack(n))}else{if(!this.world.capitalPlaced&&this.world.placeCapital(n)){this.activateGame();return}const i=Math.floor(this.troops*.5);i>0&&this.world.startExpansion(n,i)&&(this.troops-=i,console.log(`Sent ${i} troops to conquer. Remaining: ${this.troops}`))}}onWindowResize(){this.width=window.innerWidth,this.height=window.innerHeight,this.camera.aspect=this.width/this.height,this.camera.updateProjectionMatrix(),this.renderer.setSize(this.width,this.height)}}const St=({onStartGame:u})=>{const[n,i]=k.useState("Player"),{theme:e,toggleTheme:o}=K(),s=()=>{n.trim()&&u(n.trim())};return b.jsxs("div",{className:"main-menu-screen",children:[b.jsx("button",{className:"theme-toggle",onClick:o,title:"Toggle Theme",children:e==="dark"?"â˜€ï¸":"ðŸŒ™"}),b.jsxs("div",{className:"main-menu-content",children:[b.jsx("h1",{className:"game-title",children:"Sketchi"}),b.jsxs("div",{className:"nametag-container",children:[b.jsx("label",{htmlFor:"nametag",children:"Nametag"}),b.jsx("input",{id:"nametag",type:"text",value:n,onChange:a=>i(a.target.value)})]}),b.jsx("button",{className:"menu-button",onClick:s,children:"Singleplayer"})]})]})},Tt=({game:u})=>{const{cash:n,troops:i,theme:e}=K(),[o,s]=k.useState({visible:!1,x:0,y:0,intersection:null});k.useEffect(()=>{const d=m=>{m.preventDefault();const g=u.inputManager.getIntersection();g&&g.point&&s({visible:!0,x:m.clientX,y:m.clientY,intersection:g})},l=()=>{o.visible&&s(m=>({...m,visible:!1}))};return u.renderer.domElement.addEventListener("contextmenu",d),window.addEventListener("click",l),()=>{u.renderer.domElement.removeEventListener("contextmenu",d),window.removeEventListener("click",l)}},[u,o.visible]);const a=d=>{if(o.intersection){if(d==="attack"){if(u.world.isSea&&u.world.isSea(o.intersection)){console.log("Cannot expand over sea!"),s(m=>({...m,visible:!1}));return}const l=Math.max(1,i*.02);u.world.startExpansion(o.intersection,l),console.log("Expanding at",o.intersection,"with speed",l)}else if(d==="build"){if(u.world.isSea&&u.world.isSea(o.intersection)){console.log("Cannot place capital in the ocean!"),s(l=>({...l,visible:!1}));return}if(u.world.placeCapital){const l=u.world.placeCapital(o.intersection);console.log("Place capital result:",l)}else console.log("World does not support placeCapital().")}s(l=>({...l,visible:!1}))}};return b.jsxs(b.Fragment,{children:[b.jsxs("div",{id:"resource-display",style:{position:"absolute",top:"20px",left:"20px",display:"flex",flexDirection:"column",gap:"10px",color:e==="dark"?"white":"black",fontFamily:"sans-serif",fontWeight:"bold",fontSize:"20px",textShadow:"0 0 5px rgba(0,0,0,0.5)"},children:[b.jsxs("div",{id:"money-counter",children:["ðŸ’° ",Math.floor(n).toLocaleString()]}),b.jsxs("div",{id:"troop-counter",children:["âš”ï¸ ",Math.floor(i).toLocaleString()]})]}),b.jsx("div",{id:"game-hud"}),o.visible&&b.jsxs("div",{id:"context-menu",style:{position:"absolute",top:o.y,left:o.x,width:"150px",height:"150px",transform:"translate(-50%, -50%)",zIndex:1e3,pointerEvents:"none",borderRadius:"50%",background:"rgba(0, 0, 0, 0.2)"},children:[b.jsx("button",{onClick:()=>a("attack"),style:{position:"absolute",top:"0",left:"50%",transform:"translateX(-50%)",width:"60px",height:"60px",borderRadius:"50%",background:"#ff4757",color:"white",border:"2px solid white",cursor:"pointer",pointerEvents:"auto",boxShadow:"0 4px 10px rgba(0,0,0,0.3)"},children:"âš”ï¸"}),b.jsx("button",{onClick:()=>a("build"),style:{position:"absolute",bottom:"0",left:"50%",transform:"translateX(-50%)",width:"60px",height:"60px",borderRadius:"50%",background:"#2ed573",color:"white",border:"2px solid white",cursor:"pointer",pointerEvents:"auto",boxShadow:"0 4px 10px rgba(0,0,0,0.3)"},children:"ðŸš©"})]})]})};function vt(){const[u,n]=k.useState(!1),[i,e]=k.useState(!1),{theme:o}=K(),s=k.useRef(null),a=k.useRef(null),d=l=>{console.log(`Starting game for ${l}`),n(!0),s.current&&s.current.activateGame()};return k.useEffect(()=>((async()=>{if(a.current&&!s.current)try{console.log("Initializing game...");const m=new Pt(a.current);console.log("Created Game instance"),console.log("Starting world initialization..."),await m.initWorld(),console.log("World initialized successfully"),console.log("Starting game loop..."),m.start(),console.log("Game started"),s.current=m,e(!0),console.log("Game is ready!")}catch(m){console.error("Failed to initialize game:",m),e(!1)}})(),()=>{s.current&&a.current&&(a.current.innerHTML="",s.current=null,e(!1))}),[]),b.jsxs("div",{style:{width:"100vw",height:"100vh",background:o==="dark"?"#333":"#f0f0f0",position:"relative",overflow:"hidden"},children:[b.jsx("div",{ref:a,style:{width:"100%",height:"100%",position:"absolute",top:0,left:0,zIndex:0}}),!u&&b.jsx(St,{onStartGame:d}),u&&i&&s.current&&b.jsx(Tt,{game:s.current})]})}ne.createRoot(document.getElementById("app")).render(b.jsx(vt,{}));
